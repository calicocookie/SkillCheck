# 問 2
AWS 上で Application Load Balancer（以下 ALB）+ Amazon EC2 インスタンス（以下 EC2 インスタンス）+ Amazon RDS for MySQL（以下 RDS インスタンス）という構成で Web アプリケーションを開発しています。

各コンポーネントの大まかな設定は次の通りです。

|コンポーネント|設定|
|:-|:-|
|`Web アプリケーション`|インターネットに公開<br>アプリケーションのデプロイはダウンタイムなしで可能|
|`サブネット`|パブリックサブネット： インターネットゲートウェイ経由でインターネットに接続できる<br>プライベートサブネット： NAT ゲートウェイ経由でアウトバウンドはインターネットに出ることができます<br>バックエンドサブネット： インターネットへの経路を持たない<br><br>いずれのサブネットも 2AZ に存在|
|`ALB`|パブリックサブネットに配置|
|`EC2 インスタンス`|インスタンスタイプ： m5.large<br>EBS ルートボリューム： 8GB<br>Auto Scaling Group で管理し、2AZ に 1 台ずつ起動<br>プライベートサブネットに配置|
|`RDS インスタンス`|インスタンスタイプ： db.m5.large<br>エンジン： MySQL 5.7<br>シングル AZ<br>バックエンドサブネットに配置|

このアプリケーションに関する以下の小問に回答してください。

## 小問 A
アプリケーションの可用性や拡張性に関する設計を検討します。
求められる要件に対応する拡張・変更に関して、適切な選択肢を全て選択してください。
ただし、各選択肢の要件はそれぞれ独立であり、他の選択肢を考える際に考慮する必要はありません。

### 選択肢 A
1. RDS インスタンスの読み込み・書き込み性能を向上させるために、マルチ AZ DB インスタンス構成へ変更します
2. 当初想定よりリクエスト数の増加が見込まれたため、EC2 インスタンスの数を 4 台に追加したいと考えています。今の設定では RDS インスタンスの DatabaseConnections メトリクスの値が増加し、max_connections の制限に近づくことがわかりました。そこで RDS インスタンスのタイプを db.m5.large から db.m5.xlarge に変更することにします
3. アプリケーションへのアクセスに予測できないスパイクの発生が想定されています。そこで ALB から Network Load Balancer に変更することで、暖気申請せずともそういったスパイクに対応できる設計としました。ただし対策するとはいえ、Load Balancer から 5xx 系の HTTP ステータスコードを返している場合などを CloudWatch で引き続き監視します

## 小問 B
このアプリケーションの運用に関する説明のうち、最も適切な選択肢を 1 つ選んでください。

### 選択肢 B
#### 1. RDS インスタンスのスナップショットからの復元

RDS インスタンスをある時点でのスナップショットから復元し、アプリケーションにそちらのインスタンスを利用させる必要が発生しました。この作業をアプリケーションのダウンタイムが最も短くなるように実行する必要があります。

そこで現行の RDS インスタンスはそのまま稼働させつつ、バックアップから新規に RDS インスタンスを立ち上げ、ステータスが利用可能になるまで待ちます。同アカウント・リージョン内部であれば、RDS インスタンスのエンドポイントはインスタンスの識別子によって決定されるため、古い RDS インスタンスの識別子を適当に変更してから、新しく立ち上がった RDS インスタンスの識別子を元のインスタンスと同じものに変更します。

この方法が、ダウンタイムの最も短いバックアップインスタンスへの切り戻し手順となります。

#### 2. EC2 インスタンスのディスク枯渇対応

ある EC2 インスタンスの空きディスク容量が 10% を下回っているというアラートが発生し、加えて空き容量は更に減少していく状況にありました。

そこで暫定対応として、EBS ルートボリュームのサイズを 16GB に変更し、その上でファイルシステムの拡張も実行しました。また 1-2 時間程度は様子を見つつ、もし追加の容量が必要そうであればすぐにボリュームサイズを変更する予定でいます。

#### 3. メンテナンスページの表示

RDS インスタンスのエンジンバージョンを MySQL 5.7 から 8.0 までアップグレードすることにしました。この作業時間中は Web アプリケーションからメンテナンス画面を返すために、ALB の固定レスポンスを利用することとしました。

手順としては ALB にリスナールールを追加し、任意のパスへのアクセスに対して固定レスポンスでメンテナンス画面の HTML を HTTP ステータスコード 503 で返すように設定します。

バージョンアップの作業時間になれば上記作業を実施し、終わったら固定レスポンスを返すリスナールールを削除することで、作業時間中のみメンテナンスページを表示させることができます。
