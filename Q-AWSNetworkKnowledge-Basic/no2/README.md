# 問 2
以下の問題文を読み、（A）〜（K）に適切なものを選択肢から選んでください。
ひとつの選択肢が複数回使われることも、一度も使われないこともあります。

あなたはある Web アプリケーションの開発に従事しています。
インフラは AWS 上で構築されており、Application Load Balancer（以下 ALB）がリクエストを受け、ターゲットに転送。ターゲットは受信したリクエストを処理・レスポンスを返すという構成となっています。

さて、開発は順調に進み、負荷テストを実行する段階となりました。
負荷テストを実行してみたところ、稀に ALB から 502 のステータスコードが返ってきていることがわかりました。（Amazon CloudWatch Metrics における HTTPCode_ELB_502_Count）

調査を進めるにあたり、まず次のいずれが原因であるかを確認することにしました。

X. ロードバランサーはターゲットとの接続確立に失敗した

Y. ロードバランサーとターゲットは接続確立していたが、ロードバランサーからのリクエスト時に問題が発生した

また調査のために、Amazon S3（以下 S3）バケットに出力していた該当時間の ALB アクセスログ（[1]）も利用することにします。

まず X. から確認していきます。
X. が原因であるということは、つまりロードバランサーがターゲットとのスリーウェイハンドシェイク（ロードバランサーから（A）パケットの送信 → ターゲットから（B）パケットの送信 → ロードバランサーから（C）パケットの送信）に失敗していたということになります。

もしこれが正しい場合、問題となったリクエストに関する ALB アクセスログのフィールドは

- request_processing_time: -1
- target_processing_time:（D）
- response_processing_time:（E）

という値に設定されているはずです。
確認したところ、今回のアクセスログは上記に該当していないことがわかったため、まず X. が原因である可能性を潰すことができました。

次に、Y. について調べることにします。
Y. が原因である場合、各種タイムアウトの設定値に問題のある可能性が高いため、まずそれらの設定を確認することとしました。
すると、（F）よりもターゲットで設定されている keepalive に関するタイムアウトの値が（G）ことがわかりました。

また、加えて先にアクセスログを確認した結果から

- request_processing_time:（H）
- target_processing_time:（I）
- response_processing_time: -1

という値も確認できており、今回 Y. が原因の可能性が非常に高いことがわかります。

このタイムアウトの設定が原因で HTTP ステータスコード 502 の発生するプロセスを次のように整理できます。

1. ターゲットのサーバーでタイムアウトを迎えたため、ターゲットから FIN パケットが送信されます
2. 直後に ALB からの HTTP リクエストが届く。しかしターゲット側は（J）パケットを返す
   1. すなわち、（K）パケットが ALB に届く前に既に ALB からのリクエストをターゲットに転送していた
3. ターゲットからの上記パケットを ALB が受信し、最終的にクライアントへ 502 を返す

今回はターゲットの設定値を修正したところ、負荷テストで 502 のステータスコードが返されることは無くなりました。

### 選択肢
1. 0
2. -1
3. 0 以上
4. 長い
5. 短い
6. FIN
7. FIN/ACK
8. RST
9. ACK
10. SYN
11. SYN/ACK
12. ALB の idle timeout
13. ターゲットグループの deregistration delay

## Appendix
* [1] <https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-access-logs.html>
